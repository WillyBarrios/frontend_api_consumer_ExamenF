---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Consumo API SOAP">
	<div class="api-section">
		<h2>üåê Consumo de API SOAP - Banco de Guatemala</h2>
		<p>Esta secci√≥n te permite consultar directamente la API SOAP del Banco de Guatemala para obtener los tipos de cambio en tiempo real.</p>
		
		<div class="dashboard-grid">
			<div class="card">
				<h3>üì° Informaci√≥n de la API</h3>
				<div class="metric">
					<span>Endpoint SOAP</span>
					<span class="metric-value">banguat.gob.gt</span>
				</div>
				<div class="metric">
					<span>M√©todo</span>
					<span class="metric-value">TipoCambioDia</span>
				</div>
				<div class="metric">
					<span>Estado</span>
					<span class="metric-value" id="soap-api-status">
						<span class="status-indicator status-warning"></span>Verificando...
					</span>
				</div>
			</div>

			<div class="card">
				<h3>‚ö° Acciones R√°pidas</h3>
			<button class="btn btn-success" onclick="fetchFromSOAP(event)" style="width: 100%; margin: 5px 0;">
				üîÑ Consultar API SOAP Ahora
			</button>
			<button class="btn" onclick="testConnection(event)" style="width: 100%; margin: 5px 0;">
				üîç Probar Conexi√≥n
			</button>
			<button class="btn" onclick="viewRawXML(event)" style="width: 100%; margin: 5px 0;">
					üìÑ Ver XML Completo
				</button>
			</div>
		</div>

		<div class="chart-container">
			<h3>üìä Resultados de la Consulta SOAP</h3>
			<div id="soap-results">
				<div class="loading">
					<div class="spinner"></div>
					Haz clic en "Consultar API SOAP" para obtener los datos m√°s recientes...
				</div>
			</div>
		</div>

		<div class="chart-container">
			<h3>üìã Log de Consultas</h3>
			<div id="query-log">
				<p style="text-align: center; color: #666;">El log de consultas aparecer√° aqu√≠...</p>
			</div>
		</div>

		<div class="chart-container" id="xml-viewer" style="display: none;">
			<h3>üìÑ XML Response Completo</h3>
			<pre id="xml-content" style="background: #f8f9fa; padding: 20px; border-radius: 8px; overflow-x: auto; max-height: 400px;"></pre>
		</div>
	</div>
</Layout>

<script is:inline>
const API_BASE = 'http://localhost:3001/api';
let queryHistory = [];

// Verificar estado de la API SOAP
async function checkSOAPStatus() {
	try {
		const response = await fetch(`${API_BASE}/test/soap-connection`);
		const data = await response.json();
		
		document.getElementById('soap-api-status').innerHTML = data.success ? 
			`<span class="status-indicator status-success"></span>Disponible` :
			`<span class="status-indicator status-error"></span>Error`;
	} catch (error) {
		document.getElementById('soap-api-status').innerHTML = 
			`<span class="status-indicator status-error"></span>Error de conexi√≥n`;
	}
}

// Consultar directamente la API SOAP
async function fetchFromSOAP(event) {
	try {
		const button = event ? event.target : document.querySelector('button[onclick="fetchFromSOAP(event)"]');
		button.disabled = true;
		button.innerHTML = 'üîÑ Consultando...';
		
		const startTime = Date.now();
		
		// Mostrar loading
		document.getElementById('soap-results').innerHTML = `
			<div class="loading">
				<div class="spinner"></div>
				Consultando API SOAP del Banco de Guatemala...
			</div>
		`;

		// Hacer la consulta
		const response = await fetch(`${API_BASE}/actualizar-soap`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			}
		});
		const data = await response.json();
		
		const endTime = Date.now();
		const duration = endTime - startTime;

		// Registrar en el log
		const logEntry = {
			timestamp: new Date().toLocaleString(),
			duration: `${duration}ms`,
			success: data.success,
			message: data.message || 'Consulta exitosa',
			recordCount: data.data ? (data.data.totalRegistros || 0) : 0
		};
		queryHistory.unshift(logEntry);
		updateQueryLog();

		if (data.success) {
			displaySOAPResults(data);
		} else {
			document.getElementById('soap-results').innerHTML = `
				<div style="text-align: center; padding: 20px; color: #dc3545;">
					<h4>‚ùå Error en la consulta SOAP</h4>
					<p>${data.message}</p>
				</div>
			`;
		}

	} catch (error) {
		console.error('Error en consulta SOAP:', error);
		document.getElementById('soap-results').innerHTML = `
			<div style="text-align: center; padding: 20px; color: #dc3545;">
				<h4>‚ùå Error de conexi√≥n</h4>
				<p>No se pudo conectar con la API SOAP</p>
			</div>
		`;
		
		// Registrar error en el log
		queryHistory.unshift({
			timestamp: new Date().toLocaleString(),
			duration: 'N/A',
			success: false,
			message: 'Error de conexi√≥n',
			recordCount: 0
		});
		updateQueryLog();
	} finally {
		const button = event ? event.target : document.querySelector('button[onclick="fetchFromSOAP(event)"]');
		button.disabled = false;
		button.innerHTML = 'üîÑ Consultar API SOAP Ahora';
	}
}

// Mostrar resultados de la consulta SOAP
function displaySOAPResults(data) {
	let html = `
		<div style="margin-bottom: 20px;">
			<h4>‚úÖ Consulta SOAP Exitosa</h4>
			<div class="metric">
				<span>Registros procesados:</span>
				<span class="metric-value">${data.data?.totalRegistros || 0}</span>
			</div>
			<div class="metric">
				<span>Fecha de consulta:</span>
				<span class="metric-value">${new Date(data.timestamp || new Date()).toLocaleString()}</span>
			</div>
			<div class="metric">
				<span>Tiempo de respuesta:</span>
				<span class="metric-value">${data.data?.tiempoRespuesta || 'N/A'}ms</span>
			</div>
		</div>
	`;

	// Mostrar datos de cambio del d√≥lar
	if (data.data?.data?.cambioDolar && data.data.data.cambioDolar.length > 0) {
		html += `
			<h4>üí∞ Cambio del D√≥lar (Referencia)</h4>
			<table class="table">
				<thead>
					<tr>
						<th>Fecha</th>
						<th>Referencia (GTQ)</th>
					</tr>
				</thead>
				<tbody>
		`;

		data.data.data.cambioDolar.forEach(dolar => {
			html += `
				<tr>
					<td>${dolar.fecha || 'N/A'}</td>
					<td><strong>Q ${dolar.referencia || 'N/A'}</strong></td>
				</tr>
			`;
		});

		html += `</tbody></table>`;
	}

	// Mostrar tipos de cambio si hay
	if (data.data?.data?.tiposCambio && data.data.data.tiposCambio.length > 0) {
		html += `
			<h4>üí± Tipos de Cambio</h4>
			<table class="table">
				<thead>
					<tr>
						<th>Moneda</th>
						<th>Fecha</th>
						<th>Compra</th>
						<th>Venta</th>
						<th>Referencia</th>
					</tr>
				</thead>
				<tbody>
		`;

		data.data.data.tiposCambio.forEach(tipo => {
			html += `
				<tr>
					<td>Moneda ${tipo.moneda}</td>
					<td>${tipo.fecha || 'N/A'}</td>
					<td>${tipo.compra || 'N/A'}</td>
					<td>${tipo.venta || 'N/A'}</td>
					<td><strong>${tipo.referencia || 'N/A'}</strong></td>
				</tr>
			`;
		});

		html += `</tbody></table>`;
	}

	// Mostrar monedas si hay
	if (data.data?.data?.monedas && data.data.data.monedas.length > 0) {
		html += `
			<h4>üè¶ Cat√°logo de Monedas</h4>
			<table class="table">
				<thead>
					<tr>
						<th>C√≥digo</th>
						<th>Descripci√≥n</th>
						<th>S√≠mbolo</th>
					</tr>
				</thead>
				<tbody>
		`;

		data.data.data.monedas.forEach(moneda => {
			html += `
				<tr>
					<td>${moneda.codigo}</td>
					<td>${moneda.descripcion}</td>
					<td>${moneda.simbolo || 'N/A'}</td>
				</tr>
			`;
		});

		html += `</tbody></table>`;
	}

	// Si no hay datos espec√≠ficos, mostrar informaci√≥n general
	if (!data.data?.data?.cambioDolar?.length && !data.data?.data?.tiposCambio?.length && !data.data?.data?.monedas?.length) {
		html += `
			<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
				<h4>üìä Datos Procesados</h4>
				<p>La consulta SOAP se ejecut√≥ correctamente. Los datos se guardaron en la base de datos.</p>
				<p>Total de elementos procesados: <strong>${data.data?.totalRegistros || 0}</strong></p>
				<p><a href="/api-soap" onclick="window.location.reload(); return false;">üîÑ Actualizar p√°gina</a> para ver m√°s detalles.</p>
			</div>
		`;
	}

	document.getElementById('soap-results').innerHTML = html;
}

// Probar conexi√≥n con la API
async function testConnection(event) {
	try {
		const button = event ? event.target : document.querySelector('button[onclick="testConnection(event)"]');
		button.disabled = true;
		button.innerHTML = 'üîç Probando...';
		
		const response = await fetch(`${API_BASE}/test/soap-connection`);
		const data = await response.json();
		
		if (response.ok && data.success) {
			alert('‚úÖ Conexi√≥n exitosa con la API SOAP del Banco de Guatemala');
		} else {
			alert('‚ö†Ô∏è Problemas con la conexi√≥n a la API SOAP');
		}
	} catch (error) {
		alert('‚ùå Error probando conexi√≥n');
	} finally {
		const button = event ? event.target : document.querySelector('button[onclick="testConnection(event)"]');
		button.disabled = false;
		button.innerHTML = 'üîç Probar Conexi√≥n';
	}
}

// Ver XML completo de respuesta
async function viewRawXML(event) {
	try {
		const button = event ? event.target : document.querySelector('button[onclick="viewRawXML(event)"]');
		const xmlViewer = document.getElementById('xml-viewer');
		const xmlContent = document.getElementById('xml-content');
		
		if (xmlViewer.style.display === 'none') {
			button.disabled = true;
			button.innerHTML = 'üìÑ Cargando...';
			
			// Obtener XML real del backend
			try {
				const response = await fetch(`${API_BASE}/debug/xml-crudo`);
				const data = await response.json();
				
				if (data.success && data.data.xmlResponse) {
					xmlContent.textContent = data.data.xmlResponse;
				} else {
					xmlContent.textContent = `Error obteniendo XML: ${data.message || 'Error desconocido'}`;
				}
			} catch (error) {
				xmlContent.textContent = `Error de conexi√≥n: ${error.message}`;
			}
			
			xmlViewer.style.display = 'block';
			button.innerHTML = 'üôà Ocultar XML';
		} else {
			xmlViewer.style.display = 'none';
			button.innerHTML = 'üìÑ Ver XML Completo';
		}
	} catch (error) {
		alert('‚ùå Error mostrando XML');
	} finally {
		button.disabled = false;
	}
}

// Actualizar log de consultas
function updateQueryLog() {
	let html = '';
	
	if (queryHistory.length === 0) {
		html = '<p style="text-align: center; color: #666;">No hay consultas registradas a√∫n...</p>';
	} else {
		html = `
			<table class="table">
				<thead>
					<tr>
						<th>Timestamp</th>
						<th>Duraci√≥n</th>
						<th>Estado</th>
						<th>Registros</th>
						<th>Mensaje</th>
					</tr>
				</thead>
				<tbody>
		`;
		
		queryHistory.slice(0, 10).forEach(entry => {
			html += `
				<tr>
					<td>${entry.timestamp}</td>
					<td>${entry.duration}</td>
					<td>
						<span class="status-indicator ${entry.success ? 'status-success' : 'status-error'}"></span>
						${entry.success ? 'Exitoso' : 'Error'}
					</td>
					<td>${entry.recordCount}</td>
					<td>${entry.message}</td>
				</tr>
			`;
		});
		
		html += '</tbody></table>';
	}
	
	document.getElementById('query-log').innerHTML = html;
}

// Inicializar cuando carga la p√°gina
document.addEventListener('DOMContentLoaded', () => {
	checkSOAPStatus();
});

// Hacer las funciones disponibles globalmente
window.fetchFromSOAP = fetchFromSOAP;
window.testConnection = testConnection;
window.viewRawXML = viewRawXML;
</script>

<style>
.api-section h2 {
	color: #1e3c72;
	margin-bottom: 10px;
}

.api-section p {
	color: #666;
	margin-bottom: 30px;
	font-size: 1.1rem;
}
</style>