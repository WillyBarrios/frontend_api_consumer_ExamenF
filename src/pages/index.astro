---
import Layout from '../layouts/Layout.astro';
---


<Layout title="Dashboard">
	<div id="dashboard">
		<div class="dashboard-grid">
			<div class="card">
				<h3>Tipos de Cambio Actuales</h3>
				<div id="current-rates">
					<div class="loading">
						<div class="spinner"></div>
						Cargando tipos de cambio...
					</div>
				</div>
			</div>

			<div class="card">
				<h3>Dólar Estadounidense</h3>
				<div id="usd-info">
					<div class="loading">
						<div class="spinner"></div>
						Cargando información del dólar...
					</div>
				</div>
			</div>

			<div class="card">
				<h3>Estadísticas</h3>
				<div id="stats">
					<div class="loading">
						<div class="spinner"></div>
						Cargando estadísticas...
					</div>
				</div>
			</div>
		</div>

		<div class="chart-container">
			<h3>Histórico del Tipo de Cambio</h3>
			<canvas id="exchangeChart" width="400" height="200"></canvas>
		</div>

		<div class="chart-container">
			<h3>Comparativo de Monedas</h3>
			<canvas id="currencyChart" width="400" height="200"></canvas>
		</div>

		<div style="margin-top: 20px; text-align: center;">
			<button class="btn btn-success" onclick="updateData()">Actualizar Datos desde API SOAP</button>
			<button class="btn" onclick="refreshDashboard()">Refrescar Dashboard</button>
		</div>
	</div>
</Layout>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
declare const Chart: any;

declare global {
	interface Window {
		updateData: (event?: Event) => Promise<void>;
		refreshDashboard: () => Promise<void>;
	}
}

const API_BASE = 'http://localhost:3001/api';
let exchangeChart: any = null;
let currencyChart: any = null;

// Función para verificar estado del sistema (ahora solo log)
async function checkSystemStatus() {
	try {
		const healthResponse = await fetch(`${API_BASE}/../health`);
		const healthData = await healthResponse.json();
		
		console.log('Estado del Sistema:', {
			backend: 'Activo',
			database: healthData.database ? 'Conectada' : 'Error',
			soapApi: healthData.soapApi ? 'Disponible' : 'Verificando'
		});
	} catch (error) {
		console.error('Error verificando estado:', error);
	}
}

// Función para cargar tipos de cambio actuales
async function loadCurrentRates() {
	try {
		const response = await fetch(`${API_BASE}/tipos-cambio`);
		const data = await response.json();
		
		if (data.success && data.data.length > 0) {
			let html = '';
			data.data.slice(0, 3).forEach((rate: any) => {
				html += `
					<div class="metric">
						<span>${rate.simbolo} ${rate.moneda_descripcion}</span>
						<span class="metric-value">Q${rate.tipo_referencia || 'N/A'}</span>
					</div>
				`;
			});
			const currentRatesEl = document.getElementById('current-rates');
			if (currentRatesEl) currentRatesEl.innerHTML = html;
		} else {
			const currentRatesEl = document.getElementById('current-rates');
			if (currentRatesEl) currentRatesEl.innerHTML = 
				'<p style="text-align: center; color: #dc3545;">No hay datos disponibles</p>';
		}
	} catch (error) {
		console.error('Error cargando tipos de cambio:', error);
		const currentRatesEl = document.getElementById('current-rates');
		if (currentRatesEl) currentRatesEl.innerHTML = 
			'<p style="text-align: center; color: #dc3545;">Error cargando datos</p>';
	}
}

// Función para cargar información del dólar
async function loadUSDInfo() {
	try {
		const response = await fetch(`${API_BASE}/tipos-cambio/USD`);
		const data = await response.json();
		
		if (data.success && data.data.length > 0) {
			const usd = data.data[0];
			const usdInfoEl = document.getElementById('usd-info');
			if (usdInfoEl) usdInfoEl.innerHTML = `
				<div class="metric">
					<span>Fecha</span>
					<span class="metric-value">${usd.fecha}</span>
				</div>
				<div class="metric">
					<span>Referencia</span>
					<span class="metric-value">Q${usd.tipo_referencia || 'N/A'}</span>
				</div>
			`;
		} else {
			const usdInfoEl = document.getElementById('usd-info');
			if (usdInfoEl) usdInfoEl.innerHTML = 
				'<p style="text-align: center; color: #dc3545;">No hay datos disponibles</p>';
		}
	} catch (error) {
		console.error('Error cargando info USD:', error);
		const usdInfoEl = document.getElementById('usd-info');
		if (usdInfoEl) usdInfoEl.innerHTML = 
			'<p style="text-align: center; color: #dc3545;">Error cargando datos USD</p>';
	}
}

		async function loadStats() {
			try {
				const response = await fetch(`${API_BASE}/estadisticas`);
				const data = await response.json();
				
				if (data.success) {
					const stats = data.data;
					const statsEl = document.getElementById('stats');
					if (statsEl) statsEl.innerHTML = `
						<div class="metric">
							<span>Total Monedas</span>
							<span class="metric-value">${stats.totalMonedas}</span>
						</div>
						<div class="metric">
							<span>Registros Históricos</span>
							<span class="metric-value">${stats.totalRegistros}</span>
						</div>
						<div class="metric">
							<span>Última Actualización</span>
							<span class="metric-value">${stats.ultimaActualizacion || 'N/A'}</span>
						</div>
					`;
				}
			} catch (error) {
				console.error('Error cargando estadísticas:', error);
				const statsEl = document.getElementById('stats');
				if (statsEl) statsEl.innerHTML = 
					'<p style="text-align: center; color: #dc3545;">Error cargando estadísticas</p>';
			}
		}
		
		async function createExchangeChart() {
			try {
				const response = await fetch(`${API_BASE}/historico`);
				const data = await response.json();
				
				if (data.success && data.data.length > 0) {
			const chartEl = document.getElementById('exchangeChart') as HTMLCanvasElement | null;
			if (!chartEl) return;
			const ctx = chartEl.getContext('2d');
			if (!ctx) return;
			
			// Preparar datos para el gráfico
			const labels = [...new Set(data.data.map((item: any) => item.fecha))].slice(-30);
			const datasets: any[] = [];
			
			// Obtener monedas únicas
			const monedas = [...new Set(data.data.map((item: any) => item.moneda_descripcion))].slice(0, 3);
			const colores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
			
			monedas.forEach((moneda, index) => {
				const monedaData = data.data.filter((item: any) => item.moneda_descripcion === moneda);
				datasets.push({
					label: moneda,
					data: labels.map(fecha => {
						const item = monedaData.find((d: any) => d.fecha === fecha);
						return item ? item.tipo_referencia : null;
					}),
					borderColor: colores[index],
					backgroundColor: colores[index] + '20',
					tension: 0.1
				});
			});

			if (exchangeChart) {
				exchangeChart.destroy();
			}
			
			exchangeChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: datasets
				},
				options: {
					responsive: true,
					plugins: {
						title: {
							display: true,
							text: 'Histórico de Tipos de Cambio (Últimos 30 días)'
						}
					},
					scales: {
						y: {
							beginAtZero: false,
							title: {
								display: true,
								text: 'Tipo de Cambio (GTQ)'
							}
						}
					}
				}
			});
		}
	} catch (error) {
		console.error('Error creando gráfico histórico:', error);
	}
}

async function createCurrencyChart() {
	try {
		const response = await fetch(`${API_BASE}/tipos-cambio`);
		const data = await response.json();
		
		if (data.success && data.data.length > 0) {
			const monedas = data.data.slice(0, 6);
			const chartEl = document.getElementById('currencyChart') as HTMLCanvasElement | null;
			if (!chartEl) return;
			const ctx = chartEl.getContext('2d');
			
			// Obtener datos actuales de cada moneda
			const labels = monedas.map((item: any) => item.moneda_descripcion);
			const valores = monedas.map((item: any) => item.tipo_referencia || 0);
			
			if (currencyChart) {
				currencyChart.destroy();
			}
			
			currencyChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Tipo de Cambio (GTQ)',
						data: valores,
						backgroundColor: [
							'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
						],
						borderColor: [
							'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
						],
						borderWidth: 1
					}]
				},
				options: {
					responsive: true,
					plugins: {
						title: {
							display: true,
							text: 'Comparativo de Monedas Actual'
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							title: {
								display: true,
								text: 'Valor en Quetzales (GTQ)'
							}
						}
					}
				}
			});
		}
	} catch (error) {
		console.error('Error creando gráfico comparativo:', error);
	}
}

// Función para actualizar datos desde la API SOAP
window.updateData = async function(event?: Event) {
	try {
		const button = event?.target as HTMLButtonElement;
		if (!button) return;
		button.disabled = true;
		button.innerHTML = 'Actualizando...';
		
		const response = await fetch(`${API_BASE}/actualizar`, {
			method: 'POST'
		});
		const data = await response.json();
		
		if (data.success) {
			alert('Datos actualizados exitosamente desde la API SOAP');
			window.refreshDashboard();
		} else {
			alert('Error actualizando datos: ' + data.message);
		}
	} catch (error) {
		console.error('Error actualizando datos:', error);
	} finally {
		const button = event?.target as HTMLButtonElement;
		if (button) {
			button.disabled = false;
			button.innerHTML = 'Actualizar Datos desde API SOAP';
		}
	}
}

// Función para refrescar el dashboard
window.refreshDashboard = async function() {
	await Promise.all([
		checkSystemStatus(),
		loadCurrentRates(),
		loadUSDInfo(),
		loadStats(),
		createExchangeChart(),
		createCurrencyChart()
	]);
}

// Inicializar dashboard cuando la página carga
document.addEventListener('DOMContentLoaded', () => {
	window.refreshDashboard();
});

// Actualizar automáticamente cada 5 minutos
setInterval(() => window.refreshDashboard(), 300000);
</script>

<style>
	.hero {
		text-align: center;
	}
	
	.hero h2 {
		color: #333;
		margin-bottom: 20px;
		font-size: 2.5rem;
	}
	
	.hero p {
		font-size: 1.2rem;
		color: #666;
		margin-bottom: 30px;
	}
	
	.tech-stack {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 20px;
		margin: 30px 0;
	}
	
	.tech-item {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 5px 15px rgba(0,0,0,0.1);
	}
	
	.tech-item h3 {
		margin-top: 0;
		font-size: 1.5rem;
	}
	
	.tech-item p {
		margin: 5px 0;
		opacity: 0.9;
	}
	
	.features {
		background: #f8f9fa;
		padding: 20px;
		border-radius: 10px;
		margin: 30px 0;
		border-left: 4px solid #667eea;
	}
	
	.features h3 {
		color: #333;
		margin-top: 0;
	}
	
	.features ul {
		text-align: left;
		display: inline-block;
		margin: 0;
	}
	
	.features li {
		margin: 8px 0;
		color: #555;
	}
	
	.quick-start {
		background: #fff3cd;
		padding: 20px;
		border-radius: 10px;
		border-left: 4px solid #ffc107;
	}
	
	.quick-start h3 {
		color: #333;
		margin-top: 0;
	}
	
	.commands {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 15px;
		margin-top: 15px;
	}
	
	.command {
		background: white;
		padding: 15px;
		border-radius: 8px;
		border: 1px solid #dee2e6;
	}
	
	.command h4 {
		margin: 0 0 8px 0;
		color: #495057;
		font-size: 0.9rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}
	
	.command code {
		background: #f8f9fa;
		padding: 8px 12px;
		border-radius: 4px;
		font-family: 'Courier New', monospace;
		color: #e83e8c;
		display: block;
		font-size: 0.9rem;
	}
</style>
