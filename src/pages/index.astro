---
import Layout from '../layouts/Layout.astro';
---

---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Dashboard">
	<div id="dashboard">
		<div class="dashboard-grid">
			<div class="card">
				<h3>ðŸ”„ Estado del Sistema</h3>
				<div class="metric">
					<span>Backend API</span>
					<span class="metric-value" id="backend-status">
						<span class="status-indicator status-warning"></span>Verificando...
					</span>
				</div>
				<div class="metric">
					<span>Base de Datos</span>
					<span class="metric-value" id="db-status">
						<span class="status-indicator status-warning"></span>Verificando...
					</span>
				</div>
				<div class="metric">
					<span>API Banguat</span>
					<span class="metric-value" id="soap-status">
						<span class="status-indicator status-warning"></span>Verificando...
					</span>
				</div>
			</div>

			<div class="card">
				<h3>ðŸ“ˆ Tipos de Cambio Actuales</h3>
				<div id="current-rates">
					<div class="loading">
						<div class="spinner"></div>
						Cargando tipos de cambio...
					</div>
				</div>
			</div>

			<div class="card">
				<h3>ðŸ’° DÃ³lar Estadounidense</h3>
				<div id="usd-info">
					<div class="loading">
						<div class="spinner"></div>
						Cargando informaciÃ³n del dÃ³lar...
					</div>
				</div>
			</div>

			<div class="card">
				<h3>ðŸ“Š EstadÃ­sticas</h3>
				<div id="stats">
					<div class="loading">
						<div class="spinner"></div>
						Cargando estadÃ­sticas...
					</div>
				</div>
			</div>
		</div>

		<div class="chart-container">
			<h3>ðŸ“ˆ HistÃ³rico del Tipo de Cambio</h3>
			<canvas id="exchangeChart" width="400" height="200"></canvas>
		</div>

		<div class="chart-container">
			<h3>ðŸ’± Comparativo de Monedas</h3>
			<canvas id="currencyChart" width="400" height="200"></canvas>
		</div>

		<div style="margin-top: 20px; text-align: center;">
			<button class="btn btn-success" onclick="updateData()">ðŸ”„ Actualizar Datos desde API SOAP</button>
			<button class="btn" onclick="refreshDashboard()">â†» Refrescar Dashboard</button>
		</div>
	</div>
</Layout>

<script>
const API_BASE = 'http://localhost:3001/api';
let exchangeChart = null;
let currencyChart = null;

// FunciÃ³n para verificar estado del sistema
async function checkSystemStatus() {
	try {
		// Verificar backend
		const healthResponse = await fetch(`${API_BASE}/../health`);
		const healthData = await healthResponse.json();
		
		document.getElementById('backend-status').innerHTML = 
			`<span class="status-indicator status-success"></span>Activo`;
		
		document.getElementById('db-status').innerHTML = healthData.database ? 
			`<span class="status-indicator status-success"></span>Conectada` :
			`<span class="status-indicator status-error"></span>Error`;

		document.getElementById('soap-status').innerHTML = healthData.soapApi ? 
			`<span class="status-indicator status-success"></span>Disponible` :
			`<span class="status-indicator status-warning"></span>Verificando`;

	} catch (error) {
		console.error('Error verificando estado:', error);
		document.getElementById('backend-status').innerHTML = 
			`<span class="status-indicator status-error"></span>Error`;
	}
}

// FunciÃ³n para cargar tipos de cambio actuales
async function loadCurrentRates() {
	try {
		const response = await fetch(`${API_BASE}/tipos-cambio`);
		const data = await response.json();
		
		if (data.success && data.data.length > 0) {
			let html = '';
			data.data.slice(0, 3).forEach(rate => {
				html += `
					<div class="metric">
						<span>${rate.simbolo} ${rate.moneda_descripcion}</span>
						<span class="metric-value">Q${rate.tipo_referencia || 'N/A'}</span>
					</div>
				`;
			});
			document.getElementById('current-rates').innerHTML = html;
		} else {
			document.getElementById('current-rates').innerHTML = 
				'<p style="text-align: center; color: #666;">No hay datos disponibles</p>';
		}
	} catch (error) {
		console.error('Error cargando tipos de cambio:', error);
		document.getElementById('current-rates').innerHTML = 
			'<p style="text-align: center; color: #dc3545;">Error cargando datos</p>';
	}
}

// FunciÃ³n para cargar informaciÃ³n del dÃ³lar
async function loadUSDInfo() {
	try {
		const response = await fetch(`${API_BASE}/dolar`);
		const data = await response.json();
		
		if (data.success && data.data.length > 0) {
			const usd = data.data[0];
			document.getElementById('usd-info').innerHTML = `
				<div class="metric">
					<span>Fecha</span>
					<span class="metric-value">${usd.fecha}</span>
				</div>
				<div class="metric">
					<span>Referencia</span>
					<span class="metric-value">Q${usd.referencia}</span>
				</div>
			`;
		} else {
			document.getElementById('usd-info').innerHTML = 
				'<p style="text-align: center; color: #666;">No hay datos del dÃ³lar</p>';
		}
	} catch (error) {
		console.error('Error cargando info USD:', error);
		document.getElementById('usd-info').innerHTML = 
			'<p style="text-align: center; color: #dc3545;">Error cargando datos USD</p>';
	}
}

// FunciÃ³n para cargar estadÃ­sticas
async function loadStats() {
	try {
		const response = await fetch(`${API_BASE}/estadisticas`);
		const data = await response.json();
		
		if (data.success) {
			const stats = data.data;
			document.getElementById('stats').innerHTML = `
				<div class="metric">
					<span>Total Monedas</span>
					<span class="metric-value">${stats.totalMonedas}</span>
				</div>
				<div class="metric">
					<span>Registros HistÃ³ricos</span>
					<span class="metric-value">${stats.totalRegistros}</span>
				</div>
				<div class="metric">
					<span>Ãšltima ActualizaciÃ³n</span>
					<span class="metric-value">${stats.ultimaActualizacion || 'N/A'}</span>
				</div>
			`;
		}
	} catch (error) {
		console.error('Error cargando estadÃ­sticas:', error);
		document.getElementById('stats').innerHTML = 
			'<p style="text-align: center; color: #dc3545;">Error cargando estadÃ­sticas</p>';
	}
}

// FunciÃ³n para crear grÃ¡fico de histÃ³rico
async function createExchangeChart() {
	try {
		const response = await fetch(`${API_BASE}/tipos-cambio`);
		const data = await response.json();
		
		if (data.success && data.data.length > 0) {
			const ctx = document.getElementById('exchangeChart').getContext('2d');
			
			// Preparar datos para el grÃ¡fico
			const labels = [...new Set(data.data.map(item => item.fecha))].slice(-30);
			const datasets = [];
			
			// Obtener monedas Ãºnicas
			const monedas = [...new Set(data.data.map(item => item.moneda_descripcion))].slice(0, 3);
			const colores = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
			
			monedas.forEach((moneda, index) => {
				const monedaData = data.data.filter(item => item.moneda_descripcion === moneda);
				datasets.push({
					label: moneda,
					data: labels.map(fecha => {
						const item = monedaData.find(d => d.fecha === fecha);
						return item ? item.tipo_referencia : null;
					}),
					borderColor: colores[index],
					backgroundColor: colores[index] + '20',
					tension: 0.1
				});
			});

			if (exchangeChart) {
				exchangeChart.destroy();
			}
			
			exchangeChart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: datasets
				},
				options: {
					responsive: true,
					plugins: {
						title: {
							display: true,
							text: 'HistÃ³rico de Tipos de Cambio (Ãšltimos 30 dÃ­as)'
						}
					},
					scales: {
						y: {
							beginAtZero: false,
							title: {
								display: true,
								text: 'Tipo de Cambio (GTQ)'
							}
						}
					}
				}
			});
		}
	} catch (error) {
		console.error('Error creando grÃ¡fico:', error);
	}
}

// FunciÃ³n para crear grÃ¡fico comparativo de monedas
async function createCurrencyChart() {
	try {
		const response = await fetch(`${API_BASE}/tipos-cambio`);
		const data = await response.json();
		
		if (data.success && data.data.length > 0) {
			const ctx = document.getElementById('currencyChart').getContext('2d');
			
			// Obtener datos actuales de cada moneda
			const monedas = data.data.slice(0, 6);
			const labels = monedas.map(item => item.moneda_descripcion);
			const valores = monedas.map(item => item.tipo_referencia || 0);
			
			if (currencyChart) {
				currencyChart.destroy();
			}
			
			currencyChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'Tipo de Cambio (GTQ)',
						data: valores,
						backgroundColor: [
							'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
						],
						borderColor: [
							'#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
						],
						borderWidth: 1
					}]
				},
				options: {
					responsive: true,
					plugins: {
						title: {
							display: true,
							text: 'Comparativo de Monedas Actual'
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							title: {
								display: true,
								text: 'Valor en Quetzales (GTQ)'
							}
						}
					}
				}
			});
		}
	} catch (error) {
		console.error('Error creando grÃ¡fico comparativo:', error);
	}
}

// FunciÃ³n para actualizar datos desde la API SOAP
async function updateData() {
	try {
		const button = event.target;
		button.disabled = true;
		button.innerHTML = 'ðŸ”„ Actualizando...';
		
		const response = await fetch(`${API_BASE}/actualizar`, {
			method: 'POST'
		});
		const data = await response.json();
		
		if (data.success) {
			alert('âœ… Datos actualizados exitosamente desde la API SOAP');
			refreshDashboard();
		} else {
			alert('âŒ Error actualizando datos: ' + data.message);
		}
	} catch (error) {
		console.error('Error actualizando datos:', error);
		alert('âŒ Error de conexiÃ³n');
	} finally {
		const button = event.target;
		button.disabled = false;
		button.innerHTML = 'ðŸ”„ Actualizar Datos desde API SOAP';
	}
}

// FunciÃ³n para refrescar el dashboard
async function refreshDashboard() {
	await Promise.all([
		checkSystemStatus(),
		loadCurrentRates(),
		loadUSDInfo(),
		loadStats(),
		createExchangeChart(),
		createCurrencyChart()
	]);
}

// Inicializar dashboard cuando la pÃ¡gina carga
document.addEventListener('DOMContentLoaded', () => {
	refreshDashboard();
});

// Actualizar automÃ¡ticamente cada 5 minutos
setInterval(refreshDashboard, 300000);
</script>

<style>
	.hero {
		text-align: center;
	}
	
	.hero h2 {
		color: #333;
		margin-bottom: 20px;
		font-size: 2.5rem;
	}
	
	.hero p {
		font-size: 1.2rem;
		color: #666;
		margin-bottom: 30px;
	}
	
	.tech-stack {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 20px;
		margin: 30px 0;
	}
	
	.tech-item {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		padding: 20px;
		border-radius: 10px;
		box-shadow: 0 5px 15px rgba(0,0,0,0.1);
	}
	
	.tech-item h3 {
		margin-top: 0;
		font-size: 1.5rem;
	}
	
	.tech-item p {
		margin: 5px 0;
		opacity: 0.9;
	}
	
	.features {
		background: #f8f9fa;
		padding: 20px;
		border-radius: 10px;
		margin: 30px 0;
		border-left: 4px solid #667eea;
	}
	
	.features h3 {
		color: #333;
		margin-top: 0;
	}
	
	.features ul {
		text-align: left;
		display: inline-block;
		margin: 0;
	}
	
	.features li {
		margin: 8px 0;
		color: #555;
	}
	
	.quick-start {
		background: #fff3cd;
		padding: 20px;
		border-radius: 10px;
		border-left: 4px solid #ffc107;
	}
	
	.quick-start h3 {
		color: #333;
		margin-top: 0;
	}
	
	.commands {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 15px;
		margin-top: 15px;
	}
	
	.command {
		background: white;
		padding: 15px;
		border-radius: 8px;
		border: 1px solid #dee2e6;
	}
	
	.command h4 {
		margin: 0 0 8px 0;
		color: #495057;
		font-size: 0.9rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}
	
	.command code {
		background: #f8f9fa;
		padding: 8px 12px;
		border-radius: 4px;
		font-family: 'Courier New', monospace;
		color: #e83e8c;
		display: block;
		font-size: 0.9rem;
	}
</style>
